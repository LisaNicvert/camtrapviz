---
title: "Read and clean data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Read and clean data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette demonstrates how the functions included in this package can be used to read and clean different data formats.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(camtrapviz)
library(dplyr)
```

## Write data in tempfile

```{r}
# csv files ------------------------------------------
data(recordTableSample, package = "camtrapR")
data(camtraps, package = "camtrapR")

# Create subfolder
dir.create(paste0(tempdir(), "/csv"))

# Write files
recordfile <- paste0(tempdir(), "/csv/records.csv")
camtrapfile <- paste0(tempdir(), "/csv/camtraps.csv")

write.csv(recordTableSample, recordfile, 
          row.names = FALSE)
write.csv(camtraps, camtrapfile, 
          row.names = FALSE)
```


```{r}
# csv camera ------------------------------------------
# Create file
recordcam <- recordTableSample |>
  dplyr::left_join(camtraps, by = "Station")

# Create subfolder
dir.create(paste0(tempdir(), "/csvcam"))

# Write file
recordcamfile <- paste0(tempdir(), "/csvcam/recordcam.csv")
write.csv(recordcam, recordcamfile, 
          row.names = FALSE)
```


## Records and cameras in separate csv files (2 csv files)

### Read data

```{r}
dat <- read_data(path_rec = recordfile,
                 path_cam = camtrapfile,
                 sep_rec = ",", sep_cam = ",")
```

```{r}
head(dat$data$observations)
head(dat$data$deployments)
```

The imported file is a list with one component `$data` containing 2 dataframes:

+ `$observations` contains the records
+ `$deployments` contains the cameras information

### Clean data

This step ensures all columns have the desired type. It will also move these columns to the beginning of the table.

To cast data to the appropriate type, this function two arguments created below: `rec_type` (for the records table) and `cam_type` (for the cameras table).

```{r}
rec_type <- list(Station = "as.character",
                 Date = list("as_date",
                             format = "%Y-%m-%d"),
                 Time = "times",
                 DateTimeOriginal = list("as.POSIXct",
                                         tz = "Etc/GMT-8"))

cam_type <- list(Station = "as.character",
                 Setup_date = list("as.Date",
                                   format = "%d/%m/%Y"), 
                 Retrieval_date = list("as.Date",
                                       format = "%d/%m/%Y"))
```

These lists contain the information about how to convert column types.

+ Values contain the casting function to apply (e.g. `as.Date` will translate to `as.date(x)`). Values cal also be lists to provide additional arguments: for instance, `list("as.Date", format = "%d/%m/%Y")` will translate to `as.Date(x,  format = "%d/%m/%Y")`.
+ the names of the list give the corresponding column of the data that should be casted.

```{r}
dat_clean <- clean_data(dat, 
                        rec_type = rec_type,
                        cam_type = cam_type)
```


```{r}
head(dat_clean$data$observations)
head(dat_clean$data$deployments)
```

In case cameras in records and in the cameras file do not match, `clean_data` has an option allowing to keep only shared cameras.


```{r}
# Initialize new data
dat_test <- dat

# Remove a camera from the records
dat_test$data$observations <- dat_test$data$observations |> 
  filter(Station != "StationC")

# Add a camera in deployments
newcam <- dat_test$data$deployments[1, ]
newcam$Station <- "StationD"

dat_test$data$deployments <- dat_test$data$deployments |> 
  bind_rows(newcam)

# Observations has Stations A and B
unique(dat_test$data$observations$Station)
# Deployments has stations A, B, C and D
unique(dat_test$data$deployments$Station)
```


```{r}
dat_clean <- clean_data(dat_test, 
                        rec_type = rec_type,
                        cam_type = cam_type,
                        cam_col_dfrec = "Station",
                        cam_col_dfcam = "Station", 
                        only_shared_cam = TRUE)

# Observations and deployments have the same stations (A and B)
unique(dat_clean$data$observations$Station)
unique(dat_clean$data$deployments$Station)
```



## Records and cameras in the same csv (1 csv file)

### Read data

```{r}
dat <- read_data(path_rec = recordcamfile,
                 sep_rec = ",")
```

```{r}
head(dat$data$observations)
head(dat$data$deployments)
```

Again the imported file is a list with one component `$data`:

+ `$data$observations` contains the cameras and records information
+ `$data$deployments` is `NULL` (because only one file was imported)

### Clean data

This step will split the information between cameras and records. To do this, it will move all columns listed in `cam_cols` in the cameras file. The column containing cameras IDs must be specified in the `cam_col_dfrec` argument (so that it is kept in the records).

Since at the beginning all columns are in the records file, the casting specifications should be in the `rec_type` argument.

```{r}
cam_cols <- c("Station", "Setup_date", "Retrieval_date", 
              "utm_y", "utm_x", "Problem1_from", "Problem1_to")

rec_type2 <- list(Station = "as.character",
                  Date = list("as_date",
                             format = "%Y-%m-%d"),
                  Time = "times",
                  DateTimeOriginal = list("as.POSIXct",
                                         tz = "Etc/GMT-8"),
                  Setup_date = list("as.Date",
                                    format = "%d/%m/%Y"), 
                  Retrieval_date = list("as.Date",
                                        format = "%d/%m/%Y"),
                  Problem1_from = list("as.Date",
                                       format = "%d/%m/%Y"),
                  Problem1_to = list("as.Date",
                                     format = "%d/%m/%Y"))
```


```{r}
dat_clean <- clean_data(dat, 
                        rec_type = rec_type2,
                        cam_col_dfrec = "Station",
                        cam_cols = cam_cols,
                        split = TRUE)
```

```{r}
head(dat_clean$data$observations)
head(dat_clean$data$deployments)
```

## CamtrapDP format (json file)

### Read data

The `read_data` function can also read json files corresponding to camtrapDP datapackage.

```{r}
dat <- read_data(path_rec = "https://raw.githubusercontent.com/tdwg/camtrap-dp/main/example/datapackage.json")
```

Internally, we use the function `read_camtrap_dp` from the `camtraptor` package (here, it would give the same result to use use directly this function). 

The imported object is a `list` and the observations and deployments info are in the `$data` slot.

```{r}
class(dat)

head(dat$data$observations)
head(dat$data$deployments)
```

### Clean data

Here, the data follows the camtrapDP standard and does not need cleaning. However, for this demonstration we will change the time stamp type:

```{r}
dat$data$observations$timestamp <- as.character(dat$data$observations$timestamp)

# timestamp was converted to character
class(dat$data$observations$timestamp)
```


```{r}
rec_type <- list(timestamp = list("as.POSIXct",
                                  tz = "UTC"))

dat_clean <- clean_data(dat, 
                        rec_type = rec_type)

# timestamp is back to POSIX
class(dat_clean$data$observations$timestamp)
# The timezone is the one we specified
attr(dat_clean$data$observations$timestamp, "tzone")
```

```{r}
head(dat_clean$data$observations)
head(dat_clean$data$deployments)
```
