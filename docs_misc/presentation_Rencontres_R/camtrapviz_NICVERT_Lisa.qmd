---
title: "Camtrapviz, une interface Shiny pour visualiser les données de pièges photographiques"
lang: fr 
subtitle: "Rencontres R 2023, Avignon"
title-slide-attributes:
    data-background-image: "img/steenbok_kga.jpeg"
center-title-slide: false
author: 
  - name: Lisa Nicvert
    attributes:
      corresponding: true
    affiliations:
      - ref: LBBE
  - name: Stéphane Dray
    affiliations:
      - ref: LBBE
  - name: Hervé Fritz
    affiliations:
      - ref: REHABS
      - ref: SRU
affiliations: 
  - id: LBBE
    name: "Université de Lyon, Université Lyon 1, CNRS, VetAgro Sup"
    department: Laboratoire de Biométrie et Biologie  Évolutive -- UMR 5558
    city: Villeurbanne
    country: France
  - id: REHABS
    name: CNRS-NMU-UCBL, Nelson Mandela University
    department: REHABS International Research Laboratory
    city: George
    country: Afrique du Sud
  - id: SRU
    name: Sustainability Research Unit
    department: Nelson Mandela University
    city: George
    country: Afrique du Sud
date: 06-21-2023
date-format: long
format: 
  revealjs:
    menu: false
    slide-number: c/t
    show-slide-number: all
    embed-resources: true
css: style.css
engine: knitr
editor: visual
---

```{r, echo = FALSE, include=FALSE}
# include-in-header: header.html
```

## Pièges photos (camera traps)

::: columns
::: {.column width="40%"}
![Piège photo [Lisa Nicvert]{.source}](img/camtrap.JPG){fig-alt="Photo d'un piège photo installé dans une aire protégée" fig-align="left" width="90%"}
:::

::: {.column width="60%"}
-   Appareils photos à déclenchement automatique

-   Savoir quelles espèces sont présentes, quand et où
:::
:::

## Type de données

::: {layout-ncol="3" style="width: 40%; height: 110px; margin-left: auto; margin-right: auto;"}
![](img/image.png){style="opacity:0.5;" fig-align="center" width="90"}

![](img/right-arrow.png){style="opacity:0.5;" fig-align="center" width="90"}

![](img/cells.png){fig-align="center" width="90"}
:::

Souvent deux tableaux :

::: {layout="[55, -2, 43]" style="margin-bottom:0;"}
**Observations**

**Pièges photos**
:::

::: {layout="[55, -2, 43]" style="font-size: 0.6em"}
| Espèce   | Date       | Heure    | Piège photo | ... |
|----------|------------|----------|-------------|-----|
| elephant | 2023-21-06 | 14:57:12 | CAM1        |     |
| elephant | 2023-24-06 | 06:06:42 | CAM2        |     |
| gnou     | 2023-24-06 | 07:42:11 | CAM1        |     |

| Piège photo | Latitude | Longitude | ... |
|-------------|----------|-----------|-----|
| CAM1        | 43.9790  | 4.8909    |     |
| CAM2        | 43.9500  | 4.8159    |     |
| CAM3        | 43.9521  | 4.8074    |     |
:::

[[Photo icons created by Pixel perfect - Flaticon](https://www.flaticon.com/free-icons/photo) \| [Table icons created by Pixel perfect - Flaticon](https://www.flaticon.com/free-icons/table)]{.source}

## Analyses

-   **Indicateurs descriptifs :** nombre de pièges photos actifs, durée d'échantillonnage...

-   **Graphiques :** cartes, barplots d'abondances...

-   **Analyses spécifiques aux pièges photos:** activité temporelle et occupation de l'espace des espèces

::: {layout="[10, -1, 12, -1, 12]" layout-valign="center"}
```{r}
# Get dependencies
library(shinydashboard)
dashboard_ui <- dashboardPage(
  dashboardHeader(),
  dashboardSidebar(),
  dashboardBody()
)
dashboard_dep <- htmltools::findDependencies(dashboard_ui)

my_dashboard_box <- function() {
  htmltools::tagList(
    shinydashboard::infoBox("Trapping nights", 
                            icon = shiny::icon("clock"),
                            color = 'fuchsia',
                            fill = TRUE,
                            value = 55,
                            width = 12), 
    dashboard_dep)
}

my_dashboard_box()
```

```{r, echo = FALSE, out.width = '300px', out.height='230px'}
library(camtrapviz)
# library(sf)
data(camtraps, package = "camtrapR")
# camtraps_sf <- st_as_sf(camtraps, crs = 32650, coords = c("utm_x", "utm_y"))
# camtraps_sf <- camtraps_sf |> st_transform(4326)

plot_map(camtraps, 
         cam_col = "Station",
         lat_col = "utm_y", 
         lon_col = "utm_x",
         crs = 32650) 
  # leaflet::fitBounds(117.20, 5.462,
  #                    117.24, 5.492)
# mapshot(pl, file = "img/map.png",
#         remove_controls = NULL)
```

```{r, echo = FALSE, fig.width=6, fig.height=4}
library(camtrapviz)
library(ggplot2)

dat <- read.csv("https://raw.githubusercontent.com/LisaNicvert/camtrapHawkes/main/data/camtrap_data/data.csv")

# Convert hours to times format
dat$eventTime <- chron::times(dat$eventTime)

# Select the desired species
impala_records <- dat[dat$snapshotName == "impala", ]

# Fit distribution
vm <- fit_vonMises(impala_records$eventTime, k = 3)
d_vm <- vonMises_density(vm)

impala_plot <- impala_records
impala_plot$eventTime <- as.numeric(impala_plot$eventTime) * 24

ggplot(d_vm) +
        geom_histogram(data = impala_plot, 
                       aes(x = eventTime,
                           y = after_stat(density)),
                       binwidth = 1,
                       alpha = 0.7) +
        geom_line(aes(x = x, y = density), 
                  linewidth = 1.2) +
        scale_x_continuous(breaks = seq(0, 24, by = 4)) +
  xlab("Heure de la journée") +
  ylab("Densité") +
  theme_linedraw() +
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18*1.2))
```
:::

## Camtrapviz, c'est une app Shiny

![](img/camtrapviz_menu.png){fig-align="center"}

## Camtrapviz, c'est une app Shiny

::: {layout-ncol="3"}
![](img/data_import.png){fig-align="center" width="90%"}

![](img/select_data.png){fig-align="center"}

![](img/one_species.png){fig-align="center" width="90%"}
:::

## Camtrapviz, c'est aussi un package

Permet d'utiliser tous les outils du package (vignettes, documentation, facilité d'installation et gestion des dépendances)

## Shinymeta permet d'exporter le code

Le package `Shinymeta` permet de générer le code R pour reproduire l'analyse Shiny en mode non-interactif

capture d'écran -\> visualiser des morceaux de code ou télécharger le Rmd avec l'analyse complète

## Pourquoi cette app ?

-   Permettre à tout le monde de visualiser les données de pièges photos sans code : chercheur·euses, gestionnaires...

-   En s'appuyant sur l'écosystème R en écologie / analyse de données de pièges photos

## Merci !

<https://github.com/LisaNicvert/camtrapviz>

Lisa Nicvert twitter handle Linkedin
